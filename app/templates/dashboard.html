{% extends 'base.html' %}

{% block title %}Панель управления - НХТК{% endblock %}

{% block content %}
<div class="dashboard">
    <h2>Панель управления</h2>
    
    {% if user_token %}
    <div class="user-token-info">
        <h3>Ваш токен</h3>
        <div class="token-display">{{ user_token }}</div>
        <p class="token-role">Роль: 
            {% if current_user.role == 'admin' %}Администратор
            {% elif current_user.role == 'manager' %}Руководитель проекта
            {% elif current_user.role == 'supervisor' %}Куратор
            {% else %}Исполнитель
            {% endif %}
        </p>
    </div>
    {% endif %}

    <div class="stats-grid">
        <div class="stat-card">
            <h3>Всего проектов</h3>
            <div class="stat-number">{{ stats.total_projects }}</div>
        </div>
        <div class="stat-card">
            <h3>Активных проектов</h3>
            <div class="stat-number">{{ stats.active_projects }}</div>
        </div>
        <div class="stat-card">
            <h3>Всего задач</h3>
            <div class="stat-number">{{ stats.total_tasks }}</div>
        </div>
        <div class="stat-card">
            <h3>Активных задач</h3>
            <div class="stat-number">{{ stats.active_tasks }}</div>
        </div>
        <div class="stat-card">
            <h3>Завершенных задач</h3>
            <div class="stat-number">{{ stats.completed_tasks }}</div>
        </div>
    </div>

    {% if current_user.role in ['admin', 'manager'] %}
    <div class="section">
        <div class="section-header">
            <h3>Генерация токенов</h3>
        </div>
        <form action="{{ url_for('generate_token_route') }}" method="POST" class="info-box">
            <div class="form-row">
                <div class="half-width">
                    <label for="role">Роль для токена:</label>
                    <select name="role" id="role" required>
                        {% if current_user.role == 'admin' %}
                        <option value="admin">Администратор</option>
                        <option value="manager">Руководитель проекта</option>
                        {% endif %}
                        <option value="supervisor">Куратор</option>
                        <option value="worker">Исполнитель</option>
                    </select>
                </div>
                <div class="half-width">
                    <label for="project_id">Проект (для исполнителя):</label>
                    <select name="project_id" id="project_id">
                        <option value="">-- Не выбрано --</option>
                        {% for project in projects %}
                        <option value="{{ project.id }}">{{ project.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <button type="submit">Сгенерировать токен</button>
        </form>
    </div>
    {% endif %}

    <div class="section">
        <div class="section-header">
            <h3>Проекты</h3>
            {% if current_user.role in ['admin', 'manager'] %}
            <a href="{{ url_for('projects.create_project') }}" class="btn">Создать проект</a>
            {% endif %}
        </div>
        
        {% if projects %}
        <div class="projects-list">
            {% for project in projects %}
            <div class="project-card {% if project.status == 'в работе' %}status-active{% elif project.status == 'завершен' %}status-completed{% else %}status-paused{% endif %}">
                <h4>{{ project.name }}</h4>
                <p><strong>Направление:</strong> {{ project.direction }}</p>
                <p><strong>Статус:</strong> {{ project.status }}</p>
                <p><strong>Сроки:</strong> {{ project.start_date }} - {{ project.end_date }}</p>
                <a href="{{ url_for('projects.project_detail', project_id=project.id) }}" class="btn">Подробнее</a>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="no-data">Нет доступных проектов</p>
        {% endif %}
    </div>

    {% if tasks %}
    <div class="section">
        <h3>Ваши задачи</h3>
        <div class="tasks-list">
            {% for task in tasks %}
            <div class="task-card {% if task.status == 'активна' %}status-active{% elif task.status == 'завершена' %}status-completed{% else %}status-paused{% endif %}">
                <h4>{{ task.title }}</h4>
                <p><strong>Дедлайн:</strong> {{ task.deadline }}</p>
                <p><strong>Статус:</strong> {{ task.status }}</p>
                <form action="{{ url_for('tasks.update_task_status', task_id=task.id) }}" method="POST" class="status-form">
                    <select name="status" class="status-select" onchange="this.form.submit()">
                        <option value="активна" {% if task.status == 'активна' %}selected{% endif %}>Активна</option>
                        <option value="завершена" {% if task.status == 'завершена' %}selected{% endif %}>Завершена</option>
                        <option value="отложена" {% if task.status == 'отложена' %}selected{% endif %}>Отложена</option>
                    </select>
                </form>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
