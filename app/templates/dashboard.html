{% extends 'base.html' %}

{% block title %}Панель управления - НХТК{% endblock %}

{% block content %}
<div class="dashboard">
    <h2>Панель управления</h2>

    <div class="stats-grid">
        <div class="stat-card" onclick="resetFilters()" style="cursor: pointer;">
            <h3>Всего проектов</h3>
            <span class="stat-number">{{ stats.total_projects }}</span>
        </div>
        <div class="stat-card">
            <h3>Активных проектов</h3>
            <span class="stat-number">{{ stats.active_projects }}</span>
        </div>
        <div class="stat-card">
            <h3>Всего задач</h3>
            <span class="stat-number">{{ stats.total_tasks }}</span>
        </div>
        <div class="stat-card">
            <h3>Активных задач</h3>
            <span class="stat-number">{{ stats.active_tasks }}</span>
        </div>
        <div class="stat-card">
            <h3>Завершённых задач</h3>
            <span class="stat-number">{{ stats.completed_tasks }}</span>
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h3>Проекты</h3>
            <div class="section-controls">
                <div class="filter-group">
                    <select id="project-direction-filter">
                        <option value="">Все направления</option>
                        {% for d in directions %}
                        <option value="{{ d.name }}">{{ d.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <select id="project-manager-filter">
                        <option value="">Все руководители</option>
                        {% for u in users if u.role == 'manager' %}
                        <option value="{{ u.id }}">{{ u.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                 <div class="filter-group">
                    <select id="project-supervisor-filter">
                        <option value="">Все кураторы</option>
                        {% for u in users if u.role == 'supervisor' %}
                        <option value="{{ u.id }}">{{ u.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <label class="toggle-checkbox">
                    <input type="checkbox" id="show-completed-projects">
                    <span>Показать завершённые</span>
                </label>
                {% if current_user.role in ['admin', 'manager'] %}
                <a href="{{ url_for('projects.create_project') }}" class="btn">Создать проект</a>
                {% endif %}
            </div>
        </div>
        {% if projects %}
        <div class="projects-list" id="projects-list">
            {% for project in projects %}
            {% set manager = users | selectattr('id', 'equalto', project.manager_id) | first %}
            {% set supervisor = users | selectattr('id', 'equalto', project.supervisor_id) | first %}
            <div class="project-card status-{% if project.status == 'в работе' %}active{% elif project.status == 'завершен' %}completed{% else %}paused{% endif %}" 
                 data-status="{{ project.status }}"
                 data-direction="{{ project.direction }}"
                 data-manager="{{ project.manager_id }}"
                 data-supervisor="{{ project.supervisor_id }}">
                <h4>{{ project.name }}</h4>
                <p><strong>Направление:</strong> {{ project.direction or 'Не указано' }}</p>
                <p><strong>Руководитель:</strong> {{ manager.name if manager else 'Не назначен' }}</p>
                <p><strong>Статус:</strong> <span class="status-badge {% if project.status == 'в работе' %}status-active{% elif project.status == 'завершен' %}status-completed{% else %}status-paused{% endif %}">{{ project.status }}</span></p>
                <p><strong>Последняя активность:</strong> {{ project.last_activity }}</p>
                <a href="{{ url_for('projects.project_detail', project_id=project.id) }}" class="btn">Подробнее</a>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="no-data">Нет доступных проектов</p>
        {% endif %}
    </div>

    <div class="section">
        <div class="section-header">
            <h3>Мои задачи</h3>
            <div class="section-controls">
                <div class="filter-group">
                    <label for="task-project-filter">Проект:</label>
                    <select id="task-project-filter">
                        <option value="">Все проекты</option>
                        {% for project in projects %}
                        <option value="{{ project.id }}">{{ project.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label for="task-status-filter">Статус:</label>
                    <select id="task-status-filter">
                        <option value="">Все статусы</option>
                        <option value="активна">Активные</option>
                        <option value="завершена">Завершённые</option>
                        <option value="отложена">Отложенные</option>
                    </select>
                </div>
            </div>
        </div>
        {% if tasks %}
        <div class="tasks-list" id="tasks-list">
            {% for task in tasks %}
            {% set project = projects | selectattr('id', 'equalto', task.project_id) | first %}
            <div class="task-card status-{% if task.status == 'активна' %}active{% elif task.status == 'завершена' %}completed{% else %}paused{% endif %}" 
                 data-project-id="{{ task.project_id }}" 
                 data-status="{{ task.status }}">
                <h4>{{ task.title }}</h4>
                <p><strong>Проект:</strong> {{ project.name if project else 'Неизвестно' }}</p>
                <p><strong>Статус:</strong> <span class="status-badge {% if task.status == 'активна' %}status-active{% elif task.status == 'завершена' %}status-completed{% else %}status-paused{% endif %}">{{ task.status }}</span></p>
                <p><strong>Дедлайн:</strong> {{ task.deadline }}</p>
                <a href="{{ url_for('tasks.task_detail', task_id=task.id) }}" class="btn">Подробнее</a>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="no-data">Нет назначенных задач</p>
        {% endif %}
    </div>
</div>
{% endblock %}
