{% extends 'base.html' %}

{% block title %}Панель управления - НХТК{% endblock %}

{% block content %}
<div class="dashboard">
    <h2>Панель управления</h2>

    <div class="stats-grid">
        {% if current_user.role == 'admin' %}
        <!-- Статистика для администратора -->
        <div class="stat-card">
            <h3>Всего проектов в работе</h3>
            <span class="stat-number">{{ stats.total_active_projects }}</span>
        </div>
        <div class="stat-card">
            <h3>Всего проектов отложенных</h3>
            <span class="stat-number">{{ stats.total_paused_projects }}</span>
        </div>
        <div class="stat-card clickable" onclick="showOverdueProjects()">
            <h3>Проекты с просроченным дедлайном</h3>
            <span class="stat-number">{{ stats.overdue_projects_count }}</span>
        </div>
        <div class="stat-card clickable" onclick="showCuratorsList()">
            <h3>Количество кураторов</h3>
            <span class="stat-number">{{ stats.curators_count }}</span>
        </div>
        <div class="stat-card">
            <h3>Количество руководителей</h3>
            <span class="stat-number">{{ stats.managers_count }}</span>
        </div>
        <div class="stat-card">
            <h3>Количество исполнителей</h3>
            <span class="stat-number">{{ stats.executors_count }}</span>
        </div>
        {% elif current_user.role == 'curator' or current_user.role == 'supervisor' %}
        <!-- Статистика для куратора направления -->
        <div class="stat-card">
            <h3>Всего проектов в работе (мои)</h3>
            <span class="stat-number">{{ stats.my_active_projects }}</span>
        </div>
        <div class="stat-card">
            <h3>Всего приостановленных проектов (мои)</h3>
            <span class="stat-number">{{ stats.my_paused_projects }}</span>
        </div>
        <div class="stat-card clickable" onclick="showMyOverdueProjects()">
            <h3>Проекты с просроченным дедлайном (мои)</h3>
            <span class="stat-number">{{ stats.my_overdue_projects_count }}</span>
        </div>
        <div class="stat-card">
            <h3>Количество руководителей (в моих проектах)</h3>
            <span class="stat-number">{{ stats.my_managers_count }}</span>
        </div>
        <div class="stat-card">
            <h3>Количество исполнителей (в моих проектах)</h3>
            <span class="stat-number">{{ stats.my_executors_count }}</span>
        </div>
        {% elif current_user.role == 'manager' %}
        <!-- Статистика для руководителя -->
        <div class="stat-card">
            <h3>Всего проектов в работе (мои)</h3>
            <span class="stat-number">{{ stats.my_manager_active_projects }}</span>
        </div>
        <div class="stat-card">
            <h3>Всего приостановленных проектов (мои)</h3>
            <span class="stat-number">{{ stats.my_manager_paused_projects }}</span>
        </div>
        <div class="stat-card clickable" onclick="showProjectsWithOverdueTasks()">
            <h3>Проекты с просроченными задачами</h3>
            <span class="stat-number">{{ stats.projects_with_overdue_tasks_count }}</span>
        </div>
        <div class="stat-card">
            <h3>Количество исполнителей (в моих проектах)</h3>
            <span class="stat-number">{{ stats.my_manager_executors_count }}</span>
        </div>
        {% elif current_user.role == 'executor' or current_user.role == 'worker' %}
        <!-- Статистика для исполнителя -->
        <div class="stat-card">
            <h3>Общее количество задач</h3>
            <span class="stat-number">{{ stats.executor_total_tasks }}</span>
        </div>
        <div class="stat-card">
            <h3>Активные задачи</h3>
            <span class="stat-number">{{ stats.executor_active_tasks }}</span>
        </div>
        <div class="stat-card">
            <h3>Завершенные задачи</h3>
            <span class="stat-number">{{ stats.executor_completed_tasks }}</span>
        </div>
        <div class="stat-card">
            <h3>Отложенные задачи</h3>
            <span class="stat-number">{{ stats.executor_paused_tasks }}</span>
        </div>
        <div class="stat-card clickable" onclick="showOverdueExecutorTasks()">
            <h3>Просроченные задачи</h3>
            <span class="stat-number">{{ stats.executor_overdue_tasks }}</span>
        </div>
        {% endif %}
    </div>
    
    <!-- Скрипты для отображения списков при клике -->
    <script>
        function showOverdueProjects() {
            // Отправляем AJAX-запрос для получения списка просроченных проектов
            fetch('/api/overdue_projects')
                .then(response => response.json())
                .then(data => {
                    let listHTML = '<ul>';
                    data.forEach(project => {
                        listHTML += `<li><a href="/project/${project.id}">${project.name}</a></li>`;
                    });
                    listHTML += '</ul>';
                    
                    // Показываем список в модальном окне или отдельной области
                    const modal = document.createElement('div');
                    modal.innerHTML = `
                        <div class="modal-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;">
                            <div class="modal-content" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius:5px; max-height:70vh; overflow-y:auto;">
                                <h3>Проекты с просроченным дедлайном</h3>
                                ${listHTML}
                                <button onclick="this.parentElement.parentElement.remove()" style="margin-top:10px;">Закрыть</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                })
                .catch(error => console.error('Ошибка:', error));
        }
        
        function showCuratorsList() {
            // Отправляем AJAX-запрос для получения списка кураторов
            fetch('/api/curators_list')
                .then(response => response.json())
                .then(data => {
                    let listHTML = '<ul>';
                    data.forEach(curator => {
                        listHTML += `<li>${curator.name} (${curator.email})</li>`;
                    });
                    listHTML += '</ul>';
                    
                    // Показываем список в модальном окне или отдельной области
                    const modal = document.createElement('div');
                    modal.innerHTML = `
                        <div class="modal-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;">
                            <div class="modal-content" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius:5px; max-height:70vh; overflow-y:auto;">
                                <h3>Список кураторов</h3>
                                ${listHTML}
                                <button onclick="this.parentElement.parentElement.remove()" style="margin-top:10px;">Закрыть</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                })
                .catch(error => console.error('Ошибка:', error));
        }
        
        function showMyOverdueProjects() {
            // Отправляем AJAX-запрос для получения списка просроченных проектов куратора
            fetch('/api/my_overdue_projects')
                .then(response => response.json())
                .then(data => {
                    let listHTML = '<ul>';
                    data.forEach(project => {
                        listHTML += `<li><a href="/projects/${project.id}">${project.name}</a></li>`;
                    });
                    listHTML += '</ul>';
                    
                    // Показываем список в модальном окне или отдельной области
                    const modal = document.createElement('div');
                    modal.innerHTML = `
                        <div class="modal-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;">
                            <div class="modal-content" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius:5px; max-height:70vh; overflow-y:auto;">
                                <h3>Мои проекты с просроченным дедлайном</h3>
                                ${listHTML}
                                <button onclick="this.parentElement.parentElement.remove()" style="margin-top:10px;">Закрыть</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                })
                .catch(error => console.error('Ошибка:', error));
        }
        
        function showProjectsWithOverdueTasks() {
            // Отправляем AJAX-запрос для получения списка проектов с просроченными задачами
            fetch('/api/projects_with_overdue_tasks')
                .then(response => response.json())
                .then(data => {
                    let listHTML = '<ul>';
                    data.forEach(project => {
                        listHTML += `<li><a href="/projects/${project.id}">${project.name}</a></li>`;
                    });
                    listHTML += '</ul>';
                    
                    // Показываем список в модальном окне или отдельной области
                    const modal = document.createElement('div');
                    modal.innerHTML = `
                        <div class="modal-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;">
                            <div class="modal-content" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius:5px; max-height:70vh; overflow-y:auto;">
                                <h3>Проекты с просроченными задачами</h3>
                                ${listHTML}
                                <button onclick="this.parentElement.parentElement.remove()" style="margin-top:10px;">Закрыть</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                })
                .catch(error => console.error('Ошибка:', error));
        }
        
        function showOverdueExecutorTasks() {
            // Отправляем AJAX-запрос для получения списка просроченных задач исполнителя
            fetch('/api/overdue_executor_tasks')
                .then(response => response.json())
                .then(data => {
                    let listHTML = '<ul>';
                    data.forEach(task => {
                        listHTML += `<li><a href="/tasks/${task.id}">${task.title}</a></li>`;
                    });
                    listHTML += '</ul>';
                    
                    // Показываем список в модальном окне или отдельной области
                    const modal = document.createElement('div');
                    modal.innerHTML = `
                        <div class="modal-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;">
                            <div class="modal-content" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius:5px; max-height:70vh; overflow-y:auto;">
                                <h3>Просроченные задачи</h3>
                                ${listHTML}
                                <button onclick="this.parentElement.parentElement.remove()" style="margin-top:10px;">Закрыть</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                })
                .catch(error => console.error('Ошибка:', error));
        }
    </script>

    <div class="section-header">
        <h3>Список проектов</h3>
        <div class="section-controls">
            <div class="toggle-checkbox">
                <input type="checkbox" id="show-completed" {% if show_completed %}checked{% endif %}>
                <label for="show-completed">Показать завершённые</label>
            </div>
            {% if current_user.role in ['admin', 'manager'] %}
            <a href="{{ url_for('projects.create_project') }}" class="btn">Создать проект</a>
            {% endif %}
        </div>
    </div>

    <!-- Форма поиска и фильтров -->
    <div class="section-controls" style="margin-bottom: 1rem; flex-wrap: wrap;">
        <div class="filter-group">
            <label for="project-search">Поиск:</label>
            <input type="text" id="project-search" class="form-control" placeholder="Поиск по названию..." value="{{ search_query }}">
        </div>
        
        <div class="filter-group">
            <label for="project-supervisor">Руководитель:</label>
            <select id="project-supervisor" class="form-control">
                <option value="">Все руководители</option>
                {% for user in users if user.role == 'supervisor' %}
                <option value="{{ user.id }}" {% if supervisor_filter == user.id %}selected{% endif %}>
                    {{ user.full_name or user.name or user.username }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="filter-group">
            <label for="project-manager">Куратор:</label>
            <select id="project-manager" class="form-control">
                <option value="">Все кураторы</option>
                {% for user in users if user.role == 'manager' %}
                <option value="{{ user.id }}" {% if manager_filter == user.id %}selected{% endif %}>
                    {{ user.full_name or user.name or user.username }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <button id="filter-projects-btn" class="btn" style="padding: 8px 14px; font-size: 0.85rem;">Применить</button>
        <button id="clear-filters-btn" class="btn cancel-btn" style="padding: 8px 14px; font-size: 0.85rem;">Сбросить</button>
    </div>

    <div class="projects-list" id="projects-container">
        {% if projects %}
            {% for project in projects %}
            <div class="project-card status-{% if project.status == 'в работе' %}active{% elif project.status == 'завершен' %}completed{% else %}paused{% endif %}" data-name="{{ project.name|lower }}" 
                 data-supervisor="{{ project.supervisor_info.id if project.supervisor_info else '' }}" 
                 data-manager="{{ project.manager_info.id if project.manager_info else '' }}" 
                 data-status="{{ project.status }}">
                <h4>{{ project.name }}</h4>
                <p><strong>Направление:</strong> {{ project.direction or 'Не указано' }}</p>
                <p><strong>Куратор Направления:</strong> {{ project.manager_info.name if project.manager_info else 'Не указано' }}</p>
                <p><strong>Руководитель Проекта:</strong> {{ project.supervisor_info.name if project.supervisor_info else 'Не указано' }}</p>
                <p><strong>Статус:</strong> <span class="status-badge status-{{ project.status }}">{{ project.status }}</span></p>
                <p><strong>Последняя активность:</strong> {{ project.last_activity }}</p>
                <a href="{{ url_for('projects.project_detail', project_id=project.id) }}" class="btn">Подробнее</a>
            </div>
            {% endfor %}
        {% else %}
        <p class="no-data">Нет доступных проектов</p>
        {% endif %}
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('project-search');
        const curatorSelect = document.getElementById('project-curator');
        const managerSelect = document.getElementById('project-manager');
        const filterBtn = document.getElementById('filter-projects-btn');
        const clearBtn = document.getElementById('clear-filters-btn');
        const showCompletedCheckbox = document.getElementById('show-completed');
        const projectCards = document.querySelectorAll('.project-card');

        // Фильтрация при вводе в поиск
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const curatorId = curatorSelect ? curatorSelect.value : '';
                const managerId = managerSelect ? managerSelect.value : '';
                const showCompleted = showCompletedCheckbox ? showCompletedCheckbox.checked : false;

                filterProjects(searchTerm, curatorId, managerId, showCompleted);
            });
        }

        // Фильтрация при изменении селектов
        if (curatorSelect) {
            curatorSelect.addEventListener('change', applyFilters);
        }

        if (managerSelect) {
            managerSelect.addEventListener('change', applyFilters);
        }

        if (showCompletedCheckbox) {
            showCompletedCheckbox.addEventListener('change', applyFilters);
        }

        // Кнопка применения фильтров
        if (filterBtn) {
            filterBtn.addEventListener('click', applyFilters);
        }

        // Кнопка сброса фильтров
        if (clearBtn) {
            clearBtn.addEventListener('click', function() {
                if (searchInput) searchInput.value = '';
                if (curatorSelect) curatorSelect.value = '';
                if (managerSelect) managerSelect.value = '';
                if (showCompletedCheckbox) showCompletedCheckbox.checked = false;
                applyFilters();

                // Перезагрузка страницы для сброса всех параметров
                window.location.href = window.location.pathname;
            });
        }

        function applyFilters() {
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            const curatorId = curatorSelect ? curatorSelect.value : '';
            const managerId = managerSelect ? managerSelect.value : '';
            const showCompleted = showCompletedCheckbox ? showCompletedCheckbox.checked : false;

            filterProjects(searchTerm, curatorId, managerId, showCompleted);
        }

        function filterProjects(searchTerm, curatorId, managerId, showCompleted) {
            projectCards.forEach(card => {
                const projectName = card.dataset.name || '';
                const projectCurator = card.dataset.curator || '';
                const projectManager = card.dataset.manager || '';
                const projectStatus = card.dataset.status || '';

                const matchesSearch = searchTerm === '' || projectName.includes(searchTerm);
                const matchesCurator = curatorId === '' || projectCurator === curatorId;
                const matchesManager = managerId === '' || projectManager === managerId;
                const matchesStatus = showCompleted || projectStatus !== 'завершен';

                if (matchesSearch && matchesCurator && matchesManager && matchesStatus) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
    });
    </script>

    <div class="section">
        <div class="section-header">
            <h3>Мои задачи</h3>
            <div class="section-controls">
                <div class="filter-group">
                    <label for="task-project-filter">Проект:</label>
                    <select id="task-project-filter">
                        <option value="">Все проекты</option>
                        {% for project in projects %}
                        <option value="{{ project.id }}">{{ project.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label for="task-status-filter">Статус:</label>
                    <select id="task-status-filter">
                        <option value="">Все статусы</option>
                        <option value="активна">Активные</option>
                        <option value="завершена">Завершённые</option>
                        <option value="отложена">Отложенные</option>
                    </select>
                </div>
            </div>
        </div>
        {% if tasks %}
        <div class="tasks-list" id="tasks-list">
            {% for task in tasks %}
            {% set project = projects | selectattr('id', 'equalto', task.project_id) | first %}
            <div class="task-card status-{% if task.status == 'активна' %}active{% elif task.status == 'завершена' %}completed{% else %}paused{% endif %}" 
                 data-project-id="{{ task.project_id }}" 
                 data-status="{{ task.status }}">
                <h4>{{ task.title }}</h4>
                <p><strong>Проект:</strong> {{ project.name if project else 'Неизвестно' }}</p>
                <p><strong>Статус:</strong> <span class="status-badge {% if task.status == 'активна' %}status-active{% elif task.status == 'завершена' %}status-completed{% else %}status-paused{% endif %}">{{ task.status }}</span></p>
                <p><strong>Дедлайн:</strong> {{ task.deadline }}</p>
                <a href="{{ url_for('tasks.task_detail', task_id=task.id) }}" class="btn">Подробнее</a>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="no-data">Нет назначенных задач</p>
        {% endif %}
    </div>
</div>
{% endblock %}
