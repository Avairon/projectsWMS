{% extends "base.html" %}

{% block title %}–û—Ç—á–µ—Ç—ã - –ù–•–¢–ö –†–µ–µ—Å—Ç—Ä –ø—Ä–æ–µ–∫—Ç–æ–≤{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">üìä –û—Ç—á–µ—Ç—ã</h1>
    <p class="text-muted mb-4">–ù–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç—á–µ—Ç—ã –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å—Ç–∞—Ç—É—Å–∞—Ö, –∫—É—Ä–∞—Ç–æ—Ä–∞—Ö –∏ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è—Ö.</p>

    <!-- –¢–∏–ø –æ—Ç—á–µ—Ç–∞ -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="btn-group" role="group" aria-label="–¢–∏–ø –æ—Ç—á–µ—Ç–∞">
                <button type="button" class="btn btn-primary active" data-report-type="projects">
                    üìã –û—Ç—á–µ—Ç –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º
                </button>
                <button type="button" class="btn btn-outline-primary" data-report-type="tasks">
                    ‚úÖ –û—Ç—á–µ—Ç –ø–æ –∑–∞–¥–∞—á–∞–º
                </button>
            </div>
        </div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">üîç –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <!-- –ü–æ–∏—Å–∫ -->
                <div class="col-md-6">
                    <label class="form-label">–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É</label>
                    <input type="text" class="form-control" id="searchInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞...">
                    <small class="text-muted">–ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–º –ø–æ–ª—è–º (–Ω–∞–∑–≤–∞–Ω–∏–µ, —Å—Ç–∞—Ç—É—Å, –∫—É—Ä–∞—Ç–æ—Ä –∏ —Ç.–¥.)</small>
                </div>

                <!-- –ü–æ–ª–µ —Å –¥–∞—Ç–æ–π -->
                <div class="col-md-3">
                    <label class="form-label">–ü–æ–ª–µ —Å –¥–∞—Ç–æ–π</label>
                    <select class="form-select" id="dateField">
                        <option value="start_date">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</option>
                        <option value="end_date">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</option>
                    </select>
                </div>

                <!-- –¢–∏–ø —Ñ–∏–ª—å—Ç—Ä–∞ –¥–∞—Ç—ã -->
                <div class="col-md-3">
                    <label class="form-label">–¢–∏–ø —Ñ–∏–ª—å—Ç—Ä–∞</label>
                    <select class="form-select" id="dateFilterType">
                        <option value="exact">–¢–æ—á–Ω–∞—è –¥–∞—Ç–∞</option>
                        <option value="range" selected>–î–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç</option>
                    </select>
                </div>

                <!-- –¢–æ—á–Ω–∞—è –¥–∞—Ç–∞ -->
                <div class="col-md-6 date-exact d-none">
                    <label class="form-label">–î–∞—Ç–∞</label>
                    <input type="text" class="form-control datepicker" id="exactDate" placeholder="–î–î.–ú–ú.–ì–ì–ì–ì">
                </div>

                <!-- –î–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç -->
                <div class="col-md-6 date-range">
                    <label class="form-label">–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞</label>
                    <input type="text" class="form-control datepicker" id="startDate" placeholder="–î–î.–ú–ú.–ì–ì–ì–ì">
                </div>
                <div class="col-md-6 date-range">
                    <label class="form-label">–ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞</label>
                    <input type="text" class="form-control datepicker" id="endDate" placeholder="–î–î.–ú–ú.–ì–ì–ì–ì">
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                <div class="col-12">
                    <button class="btn btn-success" id="applyFiltersBtn">
                        <i class="fas fa-filter"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                    </button>
                    <button class="btn btn-secondary" id="clearFiltersBtn">
                        <i class="fas fa-eraser"></i> –û—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                    </button>
                    <button class="btn btn-primary" id="downloadReportBtn">
                        <i class="fas fa-download"></i> –°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç (Excel)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö -->
    <div class="alert alert-info d-none" id="resultsInfo">
        <strong>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong> 
        <span id="totalCount">0</span> –∑–∞–ø–∏—Å–µ–π –≤—Å–µ–≥–æ, 
        <span id="filteredCount">0</span> –∑–∞–ø–∏—Å–µ–π –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
        <span id="filterInfo" class="ms-3"></span>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">üìã –î–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç–∞</h5>
        </div>
        <div class="card-body">
            <div id="tableContainer">
                <p class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ç—á–µ—Ç–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã" –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.</p>
            </div>
        </div>
    </div>
</div>

<style>
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    .data-table th {
        background-color: #4472C4;
        color: white;
        font-weight: bold;
        padding: 12px;
        text-align: left;
        border: 1px solid #ddd;
    }

    .data-table td {
        padding: 10px;
        border: 1px solid #ddd;
        vertical-align: middle;
    }

    .data-table tr:nth-child(even) {
        background-color: #f2f2f2;
    }

    .data-table tr:nth-child(odd) {
        background-color: #ffffff;
    }

    .data-table tr:hover {
        background-color: #e3f2fd;
    }

    .number-col {
        width: 50px;
        text-align: center;
        font-weight: bold;
    }

    .datepicker {
        background-color: #fff;
        background-image: none;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.075) inset;
        color: #555;
        display: block;
        font-size: 14px;
        height: 34px;
        line-height: 1.42857;
        padding: 6px 12px;
        transition: border-color 0.15s ease-in-out 0s, box-shadow 0.15s ease-in-out 0s;
        width: 100%;
    }

    .datepicker:focus {
        border-color: #66afe9;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.075) inset, 0 0 8px rgba(102, 175, 233, 0.6);
        outline: 0 none;
    }

    .no-data {
        text-align: center;
        padding: 40px;
        color: #999;
        font-style: italic;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">

<script>
    document.addEventListener('DOMContentLoaded', function() {
        let currentReportType = 'projects';
        let tableData = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π
        flatpickr('.datepicker', {
            dateFormat: "d.m.Y",
            locale: "ru",
            allowInput: true
        });

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∏–ø–∞ –æ—Ç—á–µ—Ç–∞
        document.querySelectorAll('[data-report-type]').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('[data-report-type]').forEach(btn => {
                    btn.classList.remove('active');
                    btn.classList.add('btn-outline-primary');
                });
                this.classList.add('active');
                this.classList.remove('btn-outline-primary');
                currentReportType = this.dataset.reportType;
                
                // –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –ø—Ä–∏ —Å–º–µ–Ω–µ –æ—Ç—á–µ—Ç–∞
                clearFilters();
                document.getElementById('tableContainer').innerHTML = '<p class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ç—á–µ—Ç–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã" –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.</p>';
            });
        });

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∏–ø–∞ —Ñ–∏–ª—å—Ç—Ä–∞ –¥–∞—Ç—ã
        document.getElementById('dateFilterType').addEventListener('change', function() {
            if (this.value === 'exact') {
                document.querySelector('.date-exact').classList.remove('d-none');
                document.querySelector('.date-range').classList.add('d-none');
            } else {
                document.querySelector('.date-exact').classList.add('d-none');
                document.querySelectorAll('.date-range').forEach(el => {
                    el.classList.remove('d-none');
                });
            }
        });

        // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
        document.getElementById('applyFiltersBtn').addEventListener('click', loadReportData);

        // –û—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
        document.getElementById('clearFiltersBtn').addEventListener('click', function() {
            clearFilters();
            loadReportData();
        });

        // –°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç
        document.getElementById('downloadReportBtn').addEventListener('click', downloadReport);

        // –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('exactDate').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('dateField').value = 'start_date';
            document.getElementById('dateFilterType').value = 'range';
            document.querySelector('.date-exact').classList.add('d-none');
            document.querySelectorAll('.date-range').forEach(el => {
                el.classList.remove('d-none');
            });
            document.getElementById('resultsInfo').classList.add('d-none');
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–∞
        function loadReportData() {
            const search = document.getElementById('searchInput').value.trim();
            const dateField = document.getElementById('dateField').value;
            const dateFilterType = document.getElementById('dateFilterType').value;
            let url = `/api/reports/${currentReportType}?`;

            // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞
            if (search) {
                url += `search=${encodeURIComponent(search)}&`;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞ –¥–∞—Ç—ã
            if (dateFilterType === 'exact') {
                const exactDate = document.getElementById('exactDate').value.trim();
                if (exactDate) {
                    url += `date_field=${dateField}&start_date=${encodeURIComponent(exactDate)}`;
                }
            } else {
                const startDate = document.getElementById('startDate').value.trim();
                const endDate = document.getElementById('endDate').value.trim();
                if (startDate && endDate) {
                    url += `date_field=${dateField}&start_date=${encodeURIComponent(startDate)}&end_date=${encodeURIComponent(endDate)}`;
                } else if (startDate) {
                    url += `date_field=${dateField}&start_date=${encodeURIComponent(startDate)}`;
                }
            }

            // –£–±–∏—Ä–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π &
            url = url.replace(/[?&]$/, '');

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                    }
                    return response.json();
                })
                .then(data => {
                    tableData = data;
                    renderTable(data);
                    updateResultsInfo(data);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
                });
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
        function renderTable(data) {
            const container = document.getElementById('tableContainer');
            
            if (!data.data || data.data.length === 0) {
                container.innerHTML = '<p class="no-data">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>';
                return;
            }

            let html = '<div style="overflow-x: auto;">';
            html += '<table class="data-table">';
            html += '<thead><tr>';
            html += '<th class="number-col">#</th>';
            
            // –ó–∞–≥–æ–ª–æ–≤–∫–∏
            data.fields.forEach(field => {
                html += `<th>${field.label}</th>`;
            });
            
            html += '</tr></thead>';
            html += '<tbody>';
            
            // –î–∞–Ω–Ω—ã–µ
            data.data.forEach(row => {
                html += '<tr>';
                html += `<td class="number-col">${row.row_number}</td>`;
                
                data.fields.forEach(field => {
                    const value = row[field.name] || '';
                    html += `<td>${escapeHtml(value)}</td>`;
                });
                
                html += '</tr>';
            });
            
            html += '</tbody>';
            html += '</table>';
            html += '</div>';
            
            container.innerHTML = html;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
        function updateResultsInfo(data) {
            const infoDiv = document.getElementById('resultsInfo');
            document.getElementById('totalCount').textContent = data.total_count || 0;
            document.getElementById('filteredCount').textContent = data.filtered_count || 0;
            
            let filterText = '';
            if (data.search_query) {
                filterText += `–ü–æ–∏—Å–∫: "${data.search_query}"`;
            }
            if (Object.keys(data.filters).length > 0) {
                if (filterText) filterText += ' | ';
                for (const [field, filter] of Object.entries(data.filters)) {
                    const fieldName = data.fields.find(f => f.name === field)?.label || field;
                    if (filter.type === 'exact') {
                        filterText += `${fieldName}: ${filter.value}`;
                    } else if (filter.type === 'range') {
                        filterText += `${fieldName}: ${filter.start} - ${filter.end}`;
                    }
                }
            }
            document.getElementById('filterInfo').textContent = filterText;
            infoDiv.classList.remove('d-none');
        }

        // –°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç
        function downloadReport() {
            let url = `/api/reports/${currentReportType}/download?`;

            const search = document.getElementById('searchInput').value.trim();
            const dateField = document.getElementById('dateField').value;
            const dateFilterType = document.getElementById('dateFilterType').value;

            // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞
            if (search) {
                url += `search=${encodeURIComponent(search)}&`;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞ –¥–∞—Ç—ã
            if (dateFilterType === 'exact') {
                const exactDate = document.getElementById('exactDate').value.trim();
                if (exactDate) {
                    url += `date_field=${dateField}&start_date=${encodeURIComponent(exactDate)}`;
                }
            } else {
                const startDate = document.getElementById('startDate').value.trim();
                const endDate = document.getElementById('endDate').value.trim();
                if (startDate && endDate) {
                    url += `date_field=${dateField}&start_date=${encodeURIComponent(startDate)}&end_date=${encodeURIComponent(endDate)}`;
                } else if (startDate) {
                    url += `date_field=${dateField}&start_date=${encodeURIComponent(startDate)}`;
                }
            }

            // –£–±–∏—Ä–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π &
            url = url.replace(/[?&]$/, '');

            // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
            window.location.href = url;
        }

        // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.toString().replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadReportData();
    });
</script>
{% endblock %}