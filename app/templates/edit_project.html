{% extends 'base.html' %}

{% block title %}Редактирование проекта - НХТК{% endblock %}

{% block content %}
<div class="create-project">
    <h2>Редактирование Паспорта проекта</h2>
    <form method="POST">
        <div class="form-group">
            <label for="name">Название проекта</label>
            <input type="text" id="name" name="name" value="{{ project.name }}" required>
        </div>

        <div class="form-group">
            <label for="initiator_type">Инициатор проекта *</label>
            <select id="initiator_type" name="initiator_type" required onchange="toggleInitiatorFields()">
                <option value="">-- Выберите тип инициатора --</option>
                <optgroup label="Внешний источник">
                    <option value="ministry" {% if project.initiator_type == 'ministry' %}selected{% endif %}>Министерство образования</option>
                    <option value="national_project" {% if project.initiator_type == 'national_project' %}selected{% endif %}>Национальный проект</option>
                    <option value="regional_project" {% if project.initiator_type == 'regional_project' %}selected{% endif %}>Региональный проект</option>
                </optgroup>
                <optgroup label="Внутренний источник">
                    <option value="director" {% if project.initiator_type == 'director' %}selected{% endif %}>Директор</option>
                    <option value="deputy_director" {% if project.initiator_type == 'deputy_director' %}selected{% endif %}>Заместитель директора</option>
                    <option value="department_head" {% if project.initiator_type == 'department_head' %}selected{% endif %}>Руководитель подразделения</option>
                    <option value="teacher" {% if project.initiator_type == 'teacher' %}selected{% endif %}>Педагог колледжа</option>
                </optgroup>
            </select>
        </div>

        <div class="form-group" id="initiator_name_field" style="display: none;">
            <label for="initiator_name">ФИО инициатора *</label>
            <input type="text" id="initiator_name" name="initiator_name" value="{{ project.initiator_name or '' }}" placeholder="Введите ФИО">
        </div>

        <div class="form-group">
            <label for="direction">Направление</label>
            <select id="direction" name="direction" required>
                <option value="">-- Выберите направление --</option>
                {% for direction in directions %}
                <option value="{{ direction.name }}" {% if direction.name == project.direction %}selected{% endif %}>{{ direction.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="description">Описание проекта</label>
            <textarea id="description" name="description" rows="4" required>{{ project.description }}</textarea>
        </div>

        <div class="form-group">
            <label for="expected_result">Ожидаемый результат</label>
            <textarea id="expected_result" name="expected_result" rows="3">{{ project.expected_result }}</textarea>
        </div>

        <div class="form-row">
            <div class="half-width">
                <div class="form-group">
                    <label for="start_date">Дата начала</label>
                    <input type="text" id="start_date" value="{{ project.start_date }}" disabled>
                </div>
            </div>
            <div class="half-width">
                <div class="form-group">
                    <label for="end_date">Дата окончания (ДД.ММ.ГГГГ)</label>
                    <input type="text" id="end_date" name="end_date" value="{{ project.end_date }}" placeholder="ДД.ММ.ГГГГ">
                </div>
            </div>
        </div>
        
        <div class="form-row">
            <div class="half-width">
                <div class="form-group">
                    <label for="supervisor_id">Руководитель Проектов</label>
                    <select id="supervisor_id" name="supervisor_id">
                        <option value="">-- Не выбран --</option>
                        {% for user in users %}
                        {% if user.role in ['admin', 'supervisor', 'manager'] %}
                        <option value="{{ user.id }}" {% if user.id == project.supervisor_id %}selected{% endif %}>{{ user.name }}</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="half-width">
                <div class="form-group">
                    <label for="manager_id">Куратор Направления</label>
                    <select id="manager_id" name="manager_id" required>
                        {% for manager in managers %}
                        <option value="{{ manager.id }}" {% if manager.id == project.manager_id %}selected{% endif %}>{{ manager.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label for="status">Статус</label>
            <select id="status" name="status">
                <option value="в работе" {% if project.status == 'в работе' %}selected{% endif %}>В работе</option>
                <option value="приостановлен" {% if project.status == 'приостановлен' %}selected{% endif %}>Приостановлен</option>
                <option value="завершен" {% if project.status == 'завершен' %}selected{% endif %}>Завершён</option>
            </select>
        </div>

        <div class="form-group">
            <label for="team_search">Участники команды</label>
            <div class="team-search-container">
                <input type="text" id="team_search" class="form-control" placeholder="Поиск по ФИО...">
                <div id="team_search_results" class="search-results"></div>
                <div id="selected_team_members" class="selected-members">
                    <!-- Сюда будут добавляться выбранные участники -->
                </div>
                <input type="hidden" id="team_members_input" name="team_members" value="">
            </div>
            <small>Начните вводить ФИО для поиска участников</small>
        </div>
        
        <script>
        // Данные о пользователях передаются из бэкенда
        const allUsers = {{ users | tojson }};
            
        // Фильтруем только работников
        const workers = allUsers.filter(user => user.role === 'worker');
            
        document.addEventListener('DOMContentLoaded', function() {
            const teamSearch = document.getElementById('team_search');
            const searchResults = document.getElementById('team_search_results');
            const selectedMembers = document.getElementById('selected_team_members');
            const teamMembersInput = document.getElementById('team_members_input');
            
            let selectedUserIds = {% if project and project.team %}{{ project.team|tojson }}{% else %}[]{% endif %};
            
            // Инициализация выбранных участников
            updateSelectedMembersDisplay();
            
            // Поиск при вводе
            teamSearch.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase().trim();
                
                if (searchTerm.length < 2) {
                    searchResults.innerHTML = '';
                    searchResults.classList.remove('show');
                    return;
                }
                
                const filteredUsers = workers.filter(user => 
                    user.name.toLowerCase().includes(searchTerm) && 
                    !selectedUserIds.includes(user.id)
                );
                
                displaySearchResults(filteredUsers);
            });
            
            // Отображение результатов поиска
            function displaySearchResults(users) {
                if (users.length === 0) {
                    searchResults.innerHTML = '<div class="search-result-item no-results">Ничего не найдено</div>';
                    searchResults.classList.add('show');
                    return;
                }
                
                searchResults.innerHTML = users.map(user => `
                    <div class="search-result-item" data-id="${user.id}">
                        ${user.name}
                    </div>
                `).join('');
                
                searchResults.classList.add('show');
                
                // Добавляем обработчики кликов
                document.querySelectorAll('.search-result-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const userId = this.getAttribute('data-id');
                        const userName = this.textContent;
                        selectTeamMember(userId, userName);
                    });
                });
            }
            
            // Выбор участника
            function selectTeamMember(userId, userName) {
                if (!selectedUserIds.includes(userId)) {
                    selectedUserIds.push(userId);
                    updateSelectedMembersDisplay();
                    teamSearch.value = '';
                    searchResults.innerHTML = '';
                    searchResults.classList.remove('show');
                }
            }
            
            // Удаление участника
            function removeTeamMember(userId) {
                selectedUserIds = selectedUserIds.filter(id => id !== userId);
                updateSelectedMembersDisplay();
            }
            
            // Обновление отображения выбранных участников
            function updateSelectedMembersDisplay() {
                if (selectedUserIds.length === 0) {
                    selectedMembers.innerHTML = '<div class="no-members">Пока нет выбранных участников</div>';
                } else {
                    selectedMembers.innerHTML = selectedUserIds.map(id => {
                        const user = workers.find(u => u.id === id);
                        return user ? `
                            <div class="selected-member" data-id="${user.id}">
                                <span class="member-name">${user.name}</span>
                                <button type="button" class="remove-member-btn">×</button>
                            </div>
                        ` : '';
                    }).join('');
                    
                    // Добавляем обработчики для кнопок удаления
                    document.querySelectorAll('.selected-member .remove-member-btn').forEach((btn, index) => {
                        btn.addEventListener('click', function() {
                            const memberId = selectedUserIds[index];
                            removeTeamMember(memberId);
                        });
                    });
                }
                
                // Обновление скрытого поля
                teamMembersInput.value = selectedUserIds.join(',');
            }
        });
        </script>

        <div class="form-actions">
            <button type="submit">Сохранить</button>
            <a href="{{ url_for('projects.project_detail', project_id=project.id) }}" class="btn cancel-btn">Отмена</a>
        </div>
    </form>
</div>

<script>
function toggleInitiatorFields() {
    const initiatorType = document.getElementById('initiator_type').value;
    const nameField = document.getElementById('initiator_name_field');
    
    // Показываем поле ФИО только для внутренних источников, кроме "Директор"
    if (['deputy_director', 'department_head', 'teacher'].includes(initiatorType)) {
        nameField.style.display = 'block';
        document.getElementById('initiator_name').required = true;
    } else {
        nameField.style.display = 'none';
        document.getElementById('initiator_name').required = false;
        if (initiatorType !== 'director') {
            document.getElementById('initiator_name').value = '';
        }
    }
}

// Инициализация при загрузке
document.addEventListener('DOMContentLoaded', function() {
    toggleInitiatorFields();
    
    // Загрузка текущих участников команды
    const teamMembersInput = document.getElementById('team_members');
    const teamMemberIds = teamMembersInput.value.split(',').filter(id => id);
    
    if (teamMemberIds.length > 0) {
        const noMembersMsg = document.getElementById('no-members-message');
        if (noMembersMsg) {
            noMembersMsg.style.display = 'none';
        }
    }
});
</script>
{% endblock %}
