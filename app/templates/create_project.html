{% extends 'base.html' %}

{% block title %}Создание проекта - НХТК{% endblock %}

{% block content %}
<div class="create-project">
    <h2>Создание проекта</h2>
    <form method="POST">
        <div class="form-group">
            <label for="name">Название проекта</label>
            <input type="text" id="name" name="name" required>
        </div>

        <div class="form-group">
            <label for="direction">Направление</label>
            <select id="direction" name="direction" required>
                <option value="">-- Выберите направление --</option>
                {% for direction in directions %}
                <option value="{{ direction.name }}">{{ direction.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="description">Описание проекта</label>
            <textarea id="description" name="description" rows="4" required></textarea>
        </div>

        <div class="form-group">
            <label for="expected_result">Ожидаемый результат</label>
            <textarea id="expected_result" name="expected_result" rows="3"></textarea>
        </div>

        <div class="form-row">
            <div class="half-width">
                <div class="form-group">
                    <label for="start_date">Дата начала (ДД.ММ.ГГГГ)</label>
                    <input type="text" id="start_date" name="start_date" required placeholder="ДД.ММ.ГГГГ">
                </div>
            </div>
            <div class="half-width">
                <div class="form-group">
                    <label for="end_date">Дата окончания (ДД.ММ.ГГГГ)</label>
                    <input type="text" id="end_date" name="end_date" placeholder="ДД.ММ.ГГГГ">
                </div>
            </div>
        </div>

        <div class="form-row">
            <div class="half-width">
                <div class="form-group">
                    <label for="supervisor_id">Руководитель Проектов</label>
                    <select id="supervisor_id" name="supervisor_id">
                        <option value="">-- Не выбран --</option>
                        {% for curator in curators %}
                        <option value="{{ curator.id }}">{{ curator.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="half-width">
                <div class="form-group">
                    <label for="manager_id">Куратор Направления</label>
                    <select id="manager_id" name="manager_id" required>
                        <option value="">-- Выберите куратора --</option>
                        {% for manager in managers %}
                        <option value="{{ manager.id }}" {% if manager.id == current_user.id %}selected{% endif %}>{{ manager.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label for="status">Статус</label>
            <select id="status" name="status">
                <option value="в работе" selected>В работе</option>
                <option value="приостановлен">Приостановлен</option>
                <option value="завершен">Завершён</option>
            </select>
        </div>

        <div class="form-group">
            <label for="team_search">Участники команды</label>
            <div class="team-search-container">
                <input type="text" id="team_search" class="form-control" placeholder="Поиск по ФИО...">
                <div id="team_search_results" class="search-results"></div>
                <div id="selected_team_members" class="selected-members">
                    <!-- Сюда будут добавляться выбранные участники -->
                </div>
                <input type="hidden" id="team_members_input" name="team_members" value="">
            </div>
            <small>Начните вводить ФИО для поиска участников</small>
        </div>

        <!-- Передаем данные о пользователях через data-атрибут -->
    <script>
    // Данные о пользователях передаются из бэкенда
    const allUsers = {{ users | tojson }};
    
    // Фильтруем только работников
    const workers = allUsers.filter(user => user.role === 'worker');
    
    document.addEventListener('DOMContentLoaded', function() {
        const teamSearch = document.getElementById('team_search');
        const searchResults = document.getElementById('team_search_results');
        const selectedMembers = document.getElementById('selected_team_members');
        const teamMembersInput = document.getElementById('team_members_input');
        
        let selectedUserIds = {% if project and project.team %}{{ project.team|tojson }}{% else %}[]{% endif %};
        
        // Инициализация выбранных участников
        updateSelectedMembersDisplay();
        
        // Поиск при вводе
        teamSearch.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            if (searchTerm.length < 2) {
                searchResults.innerHTML = '';
                searchResults.classList.remove('show');
                return;
            }
            
            const filteredUsers = workers.filter(user => 
                user.name.toLowerCase().includes(searchTerm) && 
                !selectedUserIds.includes(user.id)
            );
            
            displaySearchResults(filteredUsers);
        });
        
        // Отображение результатов поиска
        function displaySearchResults(users) {
            if (users.length === 0) {
                searchResults.innerHTML = '<div class="search-result-item no-results">Ничего не найдено</div>';
                searchResults.classList.add('show');
                return;
            }
            
            searchResults.innerHTML = users.map(user => `
                <div class="search-result-item" data-id="${user.id}">
                    ${user.name}
                </div>
            `).join('');
            
            searchResults.classList.add('show');
            
            // Добавляем обработчики кликов
            document.querySelectorAll('.search-result-item').forEach(item => {
                item.addEventListener('click', function() {
                    const userId = this.getAttribute('data-id');
                    const userName = this.textContent;
                    selectTeamMember(userId, userName);
                });
            });
        }
        
        // Выбор участника
        function selectTeamMember(userId, userName) {
            if (!selectedUserIds.includes(userId)) {
                selectedUserIds.push(userId);
                updateSelectedMembersDisplay();
                teamSearch.value = '';
                searchResults.innerHTML = '';
                searchResults.classList.remove('show');
            }
        }
        
        // Удаление участника
        function removeTeamMember(userId) {
            selectedUserIds = selectedUserIds.filter(id => id !== userId);
            updateSelectedMembersDisplay();
        }
        
        // Обновление отображения выбранных участников
        function updateSelectedMembersDisplay() {
            if (selectedUserIds.length === 0) {
                selectedMembers.innerHTML = '<div class="no-members">Пока нет выбранных участников</div>';
            } else {
                selectedMembers.innerHTML = selectedUserIds.map(id => {
                    const user = workers.find(u => u.id === id);
                    return user ? `
                        <div class="selected-member" data-id="${user.id}">
                            <span class="member-name">${user.name}</span>
                            <button type="button" class="remove-member-btn">×</button>
                        </div>
                    ` : '';
                }).join('');
                
                // Добавляем обработчики для кнопок удаления
                document.querySelectorAll('.selected-member .remove-member-btn').forEach((btn, index) => {
                    btn.addEventListener('click', function() {
                        const memberId = selectedUserIds[index];
                        removeTeamMember(memberId);
                    });
                });
            }
            
            // Обновление скрытого поля
            teamMembersInput.value = selectedUserIds.join(',');
        }
    });
    </script>

        <div class="form-actions">
            <button type="submit">Создать проект</button>
            <a href="{{ url_for('dashboard.dashboard') }}" class="btn cancel-btn">Отмена</a>
        </div>
    </form>
</div>
{% endblock %}
