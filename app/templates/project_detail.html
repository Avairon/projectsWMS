{% extends 'base.html' %}

{% block title %}{{ project.name }} - НХТК{% endblock %}

{% block styles %}
<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.stat-card {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    text-align: center;
}

.stat-card h4 {
    margin: 0 0 10px 0;
    color: #495057;
    font-size: 14px;
}

.stat-value {
    font-size: 24px;
    font-weight: bold;
    color: #0d6efd;
    margin: 0;
}

.employee-stats-table {
    margin-top: 20px;
}

.employee-stats-table table {
    width: 100%;
    border-collapse: collapse;
}

.employee-stats-table th,
.employee-stats-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #dee2e6;
}

.statistics-container {
    padding: 20px 0;
}
</style>
{% endblock %}

{% block content %}
<div class="project-detail">
    <div class="actions-bar">
        <a href="{{ url_for('dashboard.dashboard') }}" class="btn back-btn">Назад</a>
        {% if current_user.role in ['admin', 'manager'] %}
        <a href="{{ url_for('projects.edit_project', project_id=project.id) }}" class="btn">Редактировать</a>
        {% endif %}
    </div>

    <h2>{{ project.name }}</h2>

    <div class="info-grid">
        <div class="info-item">
            <strong>Куратор Направления</strong>
            <p>{{ manager.name if manager else 'Не назначен' }}</p>
        </div>
        <div class="info-item">
            <strong>Руководитель Проектов</strong>
            <p>{{ supervisor.name if supervisor else 'Не назначен' }}</p>
        </div>
        <div class="info-item">
            <strong>Направление</strong>
            <p>{{ project.direction or 'Не указано' }}</p>
        </div>
        <div class="info-item">
            <strong>Дата начала</strong>
            <p>
                {% if project.start_date %}
                    {% if project.start_date is string %}
                        {{ project.start_date.split('-')[2] }}{{ project.start_date.split('-')[1] }}{{ project.start_date.split('-')[0] }}
                    {% else %}
                        {{ project.start_date.strftime('%d.%m.%Y') }}
                    {% endif %}
                {% else %}
                    Не указана
                {% endif %}
            </p>
        </div>
        <div class="info-item">
            <strong>Дата окончания</strong>
            <p>{{ project.end_date or 'Не указана' }}</p>
        </div>
        <div class="info-item">
            <strong>Статус</strong>
            <p><span class="status-badge {% if project.status == 'в работе' %}status-active{% elif project.status == 'завершен' %}status-completed{% else %}status-paused{% endif %}">{{ project.status }}</span></p>
        </div>
    </div>

    <div class="project-description">
        <h3>Описание проекта</h3>
        <p>{{ project.description or 'Нет описания' }}</p>
    </div>

    <div class="project-result">
        <h3>Ожидаемый результат</h3>
        <p>{{ project.expected_result or 'Не указан' }}</p>
    </div>

    <button class="toggle-btn" onclick="toggleTeam()">Показать/скрыть команду проекта</button>
    <div class="project-team" style="display:none;" id="project-team-section">
        <h3>Команда проекта</h3>
        {% if team_members %}
        <ul class="team-list">
            <!-- Handle case where supervisor and manager are the same person -->
            {% if supervisor and manager and supervisor.id == manager.id %}
            <li>
                <span class="member-name">{{ supervisor.name }}</span>
                <span class="role-badge role-supervisor">Куратор и Руководитель</span>
            </li>
            {% else %}
                <!-- Place curator first if exists and different from manager -->
                {% if supervisor %}
                <li>
                    <span class="member-name">{{ manager.name }}</span>
                    <span class="role-badge role-supervisor">Куратор</span>
                </li>
                {% endif %}
                
                <!-- Place manager second if exists -->
                {% if manager %}
                <li>
                    <span class="member-name">{{ supervisor.name }}</span>
                    <span class="role-badge role-manager">Руководитель</span>
                </li>
                {% endif %}
            {% endif %}
            
            <!-- Add remaining team members -->
            {% for member in team_members %}
                {% if member.id != (supervisor.id if supervisor else 'none') and member.id != (manager.id if manager else 'none') %}
                <li>
                    <span class="member-name">{{ member.name }}</span>
                    <span class="role-badge role-{{ member.role }}">
                        {% if member.role == 'admin' %}Администратор
                        {% elif member.role == 'manager' %}Руководитель
                        {% elif member.role == 'supervisor' %}Куратор
                        {% else %}Исполнитель
                        {% endif %}
                    </span>
                </li>
                {% endif %}
            {% endfor %}
        </ul>
        {% else %}
        <p class="no-data">Нет участников</p>
        {% endif %}
    </div>

    <div class="project-tabs">
        <button class="tab-btn active" data-tab="tasks-tab">Список задач</button>
        <button class="tab-btn" data-tab="gantt-tab">Диаграмма Ганта</button>
        <button class="tab-btn" data-tab="stats-tab">Статистика</button>
    </div>

    <div id="tasks-tab" class="tab-content active">
        <div class="project-tasks">
            <div class="section-header">
                <h3>Задачи проекта</h3>
                {% if current_user.role in ['admin', 'manager'] %}
                <a href="{{ url_for('tasks.create_task', project_id=project.id) }}" class="btn">Добавить задачу</a>
                {% endif %}
            </div>
            {% if tasks %}
            <div class="table-wrapper">
                <table class="tasks-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Название</th>
                            <th>Исполнитель</th>
                            <th>Дата начала</th>
                            <th>Дедлайн</th>
                            <th>Статус</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in tasks %}
                        {% set assignee = users | selectattr('id', 'equalto', task.assignee_id) | first %}
                        <tr class="task-row" data-task-id="{{ task.id }}">
                            <td>{{ loop.index }}</td>
                            <td>{{ task.title }}</td>
                            <td>{{ assignee.name if assignee else 'Не назначен' }}</td>
                            <td>{{ task.start_date or '-' }}</td>
                            <td>{{ task.deadline }}</td>
                            <td>
                                <span class="status-badge {% if task.status == 'активна' %}status-active{% elif task.status == 'завершена' %}status-completed{% else %}status-paused{% endif %}">{{ task.status }}</span>
                            </td>
                            <td>
                                <button class="btn small-btn edit-task-btn" data-task-id="{{ task.id }}">Изменить</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="no-data">Нет задач в проекте</p>
            {% endif %}
        </div>
    </div>

    <div id="gantt-tab" class="tab-content">
        <div class="gantt-container">
            <div class="gantt-header">
                <h3>Диаграмма Ганта</h3>
                <div class="gantt-controls">
                    <button class="btn small-btn gantt-zoom-btn" data-zoom="day">День</button>
                    <button class="btn small-btn gantt-zoom-btn active" data-zoom="week">Неделя</button>
                    <button class="btn small-btn gantt-zoom-btn" data-zoom="month">Месяц</button>
                    <button class="btn small-btn gantt-zoom-btn" data-zoom="year">Год</button>
                </div>
            </div>
            <div class="gantt-chart" id="gantt-chart" data-project-id="{{ project.id }}">
            </div>
            <div class="gantt-legend">
                <div class="legend-item">
                    <span class="legend-color status-active"></span>
                    <span>Активные</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color status-completed"></span>
                    <span>Завершённые</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color status-paused"></span>
                    <span>Отложенные</span>
                </div>
            </div>
        </div>
    </div>

    <div id="stats-tab" class="tab-content">
        <div class="statistics-container">
            <h3>Статистика проекта</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <h4>% Не выполненных задач</h4>
                    <p class="stat-value">{{ "%.2f"|format(project_stats.percent_incomplete) }}%</p>
                </div>
                <div class="stat-card">
                    <h4>% Выполненных задач в срок</h4>
                    <p class="stat-value">{{ "%.2f"|format(project_stats.percent_completed_on_time) }}%</p>
                </div>
                <div class="stat-card">
                    <h4>Количество сотрудников</h4>
                    <p class="stat-value">{{ project_stats.employee_count }}</p>
                </div>
            </div>

            <h3>Статистика сотрудников</h3>
            {% if employee_stats %}
            <div class="employee-stats-table">
                <table class="tasks-table">
                    <thead>
                        <tr>
                            <th>Сотрудник</th>
                            <th>Всего задач выполнено</th>
                            <th>% выполненных задач в срок</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for emp_stat in employee_stats %}
                        <tr>
                            <td>{{ emp_stat.name }}</td>
                            <td>{{ emp_stat.total_completed_tasks }}</td>
                            <td>{{ "%.2f"|format(emp_stat.percent_completed_on_time) }}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="no-data">Нет данных о сотрудниках проекта</p>
            {% endif %}
        </div>
    </div>
</div>

<div id="task-modal" class="modal">
    <div class="modal-content large-modal">
        <div class="modal-header">
            <h3>Редактирование задачи</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <form id="edit-task-form">
                <input type="hidden" id="edit-task-id" name="task_id">
                <div class="form-group">
                    <label for="edit-task-title">Название</label>
                    <input type="text" id="edit-task-title" name="title" required>
                </div>
                <div class="form-group">
                    <label for="edit-task-description">Описание</label>
                    <textarea id="edit-task-description" name="description" rows="3"></textarea>
                </div>
                <div class="form-row">
                    <div class="half-width">
                        <div class="form-group">
                            <label for="edit-task-assignee">Исполнитель</label>
                            <select id="edit-task-assignee" name="assignee_id"></select>
                        </div>
                    </div>
                    <div class="half-width">
                        <div class="form-group">
                            <label for="edit-task-status">Статус</label>
                            <select id="edit-task-status" name="status">
                                <option value="активна">Активна</option>
                                <option value="завершена">Завершена</option>
                                <option value="отложена">Отложена</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="half-width">
                        <div class="form-group">
                            <label for="edit-task-start">Дата начала (ДД.ММ.ГГГГ)</label>
                            <input type="text" id="edit-task-start" name="start_date" placeholder="ДД.ММ.ГГГГ">
                        </div>
                    </div>
                    <div class="half-width">
                        <div class="form-group">
                            <label for="edit-task-deadline">Дедлайн (ДД.ММ.ГГГГ)</label>
                            <input type="text" id="edit-task-deadline" name="deadline" placeholder="ДД.ММ.ГГГГ">
                        </div>
                    </div>
                </div>
                
                <!-- Подзадачи вместо отчетов -->
                <!-- Подзадачи -->
                <div class="subtasks-section" id="subtasks-container">
                    <div class="subtasks-header">
                        <h3>Подзадачи</h3>
                        <button type="button" class="btn btn-primary btn-sm" onclick="showAddSubtaskForm()">+ Добавить подзадачу</button>
                    </div>
                    
                    <!-- Форма добавления подзадачи -->
                    <div class="add-subtask-form" id="add-subtask-form" style="display: none;">
                        <h4>Новая подзадача</h4>
                        <div class="form-group">
                            <label for="new-subtask-title">Название подзадачи</label>
                            <input type="text" id="new-subtask-title" class="form-control" placeholder="Введите название подзадачи">
                        </div>
                        <div class="form-group">
                            <label for="new-subtask-date">Планируемая дата выполнения (ДД.ММ.ГГГГ)</label>
                            <input type="text" id="new-subtask-date" class="form-control" placeholder="ДД.ММ.ГГГГ">
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-success" onclick="createSubtask()">Создать</button>
                            <button type="button" class="btn btn-secondary" onclick="hideAddSubtaskForm()">Отмена</button>
                        </div>
                    </div>
                    
                    <!-- Контейнер для списка подзадач -->
                    <div class="subtasks-list" id="subtasks-list">
                        <!-- Подзадачи будут загружаться сюда через JavaScript -->
                        <div class="subtasks-loading">
                            <p>Загрузка подзадач...</p>
                        </div>
                    </div>
                </div>

                <button class="toggle-btn" onclick="toggleHistory(event)">Показать/скрыть историю изменений</button>
                <div class="task-history" id="task-history" style="display:none;">
                    <h4>История изменений</h4>
                    <div class="history-list"></div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn">Сохранить</button>
                    <button type="button" class="btn cancel-btn modal-close-btn">Отмена</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.modal-content.large-modal {
    width: 75%; /* Увеличиваем ширину модального окна в 1.5 раза */
    max-width: 1200px; /* Устанавливаем максимальную ширину */
}

.subtasks-section {
    margin-top: 20px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    min-height: 100px;
}

.subtasks-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #dee2e6;
}

.subtasks-header h3 {
    margin: 0;
    color: #333;
    font-size: 18px;
}

.subtasks-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.subtask-item {
    display: grid;
    grid-template-columns: 60px 1fr 180px 1fr 120px;
    gap: 10px;
    padding: 15px;
    background: white;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    align-items: center;
    transition: all 0.3s ease;
}

.subtask-item:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.subtask-item.completed {
    background: #d4edda;
    border-left: 4px solid #28a745;
}

.subtask-item.pending {
    background: #fff3cd;
    border-left: 4px solid #ffc107;
}

.subtask-checkbox {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
}

.subtask-checkbox input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: #007bff;
}

.status-icon {
    font-size: 20px;
    font-weight: bold;
    width: 20px;
    text-align: center;
}

.status-icon.completed {
    color: #28a745;
}

.status-icon.pending {
    color: #dc3545;
}

.subtask-title {
    font-weight: 500;
    color: #333;
    word-break: break-word;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.subtask-dates {
    display: flex;
    flex-direction: column;
    font-size: 12px;
    color: #666;
}

.subtask-dates span {
    margin: 2px 0;
    white-space: nowrap;
}

.subtask-report {
    font-size: 13px;
    color: #555;
    font-style: italic;
    max-width: 300px;
    word-break: break-word;
}

.subtask-file {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 12px;
}

.subtask-file.file-attached {
    color: #007bff;
}

.subtask-file i {
    color: #007bff;
}

.subtask-actions {
    display: flex;
    gap: 5px;
    justify-content: flex-end;
}

.subtask-actions button {
    padding: 5px 10px;
    font-size: 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-success:hover {
    background: #218838;
}

.btn-info {
    background: #17a2b8;
    color: white;
}

.btn-info:hover {
    background: #138496;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    background: #c82333;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 12px;
}

.file-link {
    color: #007bff;
    text-decoration: none;
}

.file-link:hover {
    text-decoration: underline;
}

.file-size {
    color: #666;
    font-size: 11px;
}

.no-subtasks {
    text-align: center;
    padding: 40px 20px;
    color: #666;
}

.no-subtasks p {
    margin-bottom: 15px;
    font-size: 16px;
}

.subtask-edit-form {
    display: flex;
    flex-direction: column;
    gap: 15px;
    grid-column: span 6;
}

.current-file {
    color: #28a745;
    font-size: 13px;
    margin-top: 5px;
}

.subtasks-loading {
    text-align: center;
    padding: 30px;
    color: #999;
}

.add-subtask-form {
    background: white;
    padding: 20px;
    border-radius: 6px;
    margin-bottom: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    grid-column: span 6;
}

.add-subtask-form h4 {
    margin-top: 0;
    margin-bottom: 15px;
    color: #333;
    font-size: 16px;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #555;
    font-size: 13px;
}

.form-control {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
}

.form-control:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
}

.form-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.subtask-file-info {
    display: flex;
    align-items: center;
    gap: 8px;
    background: #e7f3ff;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 12px;
}

.file-remove {
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 2px 6px;
    cursor: pointer;
    font-size: 10px;
}

.file-remove:hover {
    background: #c82333;
}
</style>

<script>
// Загружаем подзадачи при открытии модального окна
let currentTaskId = null;

document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('task-modal');
    if (modal) {
        modal.addEventListener('shown.bs.modal', function() {
            const taskId = document.getElementById('edit-task-id').value;
            if (taskId) {
                currentTaskId = taskId;
                loadSubtasks(taskId);
            }
        });
    }
});

// Функция загрузки подзадач
async function loadSubtasks(taskId) {
    try {
        const response = await fetch(`/task/${taskId}/subtasks`);
        const subtasks = await response.json();
        
        if (!response.ok) {
            throw new Error(subtasks.error || 'Ошибка загрузки подзадач');
        }
        
        renderSubtasks(subtasks);
    } catch (error) {
        console.error('Ошибка загрузки подзадач:', error);
        document.getElementById('subtasks-list').innerHTML = `<div class="no-subtasks"><p>Ошибка загрузки подзадач: ${error.message}</p></div>`;
    }
}

// Функция отображения подзадач
function renderSubtasks(subtasks) {
    const container = document.getElementById('subtasks-list');
    
    if (subtasks.length === 0) {
        container.innerHTML = '<div class="no-subtasks"><p>Нет подзадач</p><p>Добавьте первую подзадачу</p></div>';
        return;
    }
    
    const subtasksHtml = subtasks.map(subtask => `
        <div class="subtask-item ${subtask.completed ? 'completed' : 'pending'}" data-subtask-id="${subtask.id}">
            <div class="subtask-checkbox">
                <input type="checkbox" ${subtask.completed ? 'checked' : ''} onchange="toggleSubtaskStatus('${subtask.id}', this.checked)">
                <span class="status-icon ${subtask.completed ? 'completed' : 'pending'}">
                    ${subtask.completed ? '✓' : '✗'}
                </span>
            </div>
            <div class="subtask-title">${subtask.title}</div>
            <div class="subtask-dates">
                <span class="planned-date">Запланировано: ${subtask.planned_date || '-'}</span>
                <span class="completed-date">Сделано: ${subtask.completed_date || '-'}</span>
            </div>
            <div class="subtask-report">
                ${subtask.report ? `<span class="report-text">${subtask.report}</span>` : ''}
            </div>
            <div class="subtask-file ${subtask.file ? 'file-attached' : ''}">
                ${subtask.file ? `
                    <i class="fas fa-paperclip"></i>
                    <a href="/uploads/${subtask.file.executor_dir}/${subtask.file.unique_filename}" download class="file-link">
                        ${subtask.file.filename}
                    </a>
                    <span class="file-size">(${formatFileSize(subtask.file.size)})</span>
                ` : ''}
            </div>
            <div class="subtask-actions">
                <button type="button" class="btn btn-info btn-sm" onclick="showEditSubtaskForm('${subtask.id}')">Редакт.</button>
                <button type="button" class="btn btn-success btn-sm" onclick="showReportModal('${subtask.id}')">Отчет</button>
                ${current_user.role in ['admin', 'manager', 'supervisor'] ? 
                    `<button type="button" class="btn btn-danger btn-sm" onclick="deleteSubtask('${subtask.id}')">Удалить</button>` : ''}
            </div>
        </div>
    `).join('');
    
    container.innerHTML = subtasksHtml;
}

// Функция показа формы добавления подзадачи
function showAddSubtaskForm() {
    document.getElementById('add-subtask-form').style.display = 'block';
}

// Функция скрытия формы добавления подзадачи
function hideAddSubtaskForm() {
    document.getElementById('add-subtask-form').style.display = 'none';
    document.getElementById('new-subtask-title').value = '';
    document.getElementById('new-subtask-date').value = '';
}

// Функция создания подзадачи
async function createSubtask() {
    const title = document.getElementById('new-subtask-title').value.trim();
    const plannedDate = document.getElementById('new-subtask-date').value.trim();
    
    if (!title) {
        alert('Введите название подзадачи');
        return;
    }
    
    try {
        const response = await fetch(`/task/${currentTaskId}/subtask`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `title=${encodeURIComponent(title)}&planned_date=${encodeURIComponent(plannedDate)}`
        });
        
        const result = await response.json();
        
        if (result.success) {
            hideAddSubtaskForm();
            loadSubtasks(currentTaskId); // Перезагружаем список подзадач
        } else {
            alert('Ошибка создания подзадачи: ' + (result.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Ошибка создания подзадачи:', error);
        alert('Ошибка создания подзадачи: ' + error.message);
    }
}

// Функция переключения статуса подзадачи
async function toggleSubtaskStatus(subtaskId, completed) {
    try {
        const response = await fetch(`/task/${currentTaskId}/subtask/${subtaskId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `completed=${completed}`
        });
        
        const result = await response.json();
        
        if (!result.success) {
            alert('Ошибка обновления статуса подзадачи: ' + (result.error || 'Неизвестная ошибка'));
            // Восстановим предыдущий статус в интерфейсе
            const checkbox = event.target;
            checkbox.checked = !completed;
            const icon = checkbox.nextElementSibling;
            icon.className = `status-icon ${!completed ? 'completed' : 'pending'}`;
            icon.textContent = !completed ? '✓' : '✗';
        }
    } catch (error) {
        console.error('Ошибка обновления статуса подзадачи:', error);
        alert('Ошибка обновления статуса подзадачи: ' + error.message);
        // Восстановим предыдущий статус в интерфейсе
        const checkbox = event.target;
        checkbox.checked = !completed;
        const icon = checkbox.nextElementSibling;
        icon.className = `status-icon ${!completed ? 'completed' : 'pending'}`;
        icon.textContent = !completed ? '✓' : '✗';
    }
}

// Функция показа формы редактирования подзадачи
function showEditSubtaskForm(subtaskId) {
    // Находим элемент подзадачи
    const subtaskElement = document.querySelector(`[data-subtask-id="${subtaskId}"]`);
    const titleElement = subtaskElement.querySelector('.subtask-title');
    const titleText = titleElement.textContent;
    
    // Создаем форму редактирования
    const editForm = document.createElement('div');
    editForm.className = 'subtask-edit-form';
    editForm.innerHTML = `
        <div class="form-group">
            <label for="edit-subtask-title-${subtaskId}">Название подзадачи</label>
            <input type="text" id="edit-subtask-title-${subtaskId}" class="form-control" value="${titleText}" placeholder="Введите название подзадачи">
        </div>
        <div class="form-group">
            <label for="edit-subtask-date-${subtaskId}">Планируемая дата выполнения (ДД.ММ.ГГГГ)</label>
            <input type="text" id="edit-subtask-date-${subtaskId}" class="form-control" placeholder="ДД.ММ.ГГГГ">
        </div>
        <div class="form-actions">
            <button type="button" class="btn btn-success" onclick="updateSubtask('${subtaskId}')">Сохранить</button>
            <button type="button" class="btn btn-secondary" onclick="cancelEditSubtask('${subtaskId}')">Отмена</button>
        </div>
    `;
    
    // Заменяем содержимое элемента подзадачи на форму редактирования
    subtaskElement.innerHTML = `<div class="subtask-edit-form">${editForm.innerHTML}</div>`;
}

// Функция обновления подзадачи
async function updateSubtask(subtaskId) {
    const title = document.getElementById(`edit-subtask-title-${subtaskId}`).value.trim();
    const plannedDate = document.getElementById(`edit-subtask-date-${subtaskId}`).value.trim();
    
    if (!title) {
        alert('Введите название подзадачи');
        return;
    }
    
    try {
        const response = await fetch(`/task/${currentTaskId}/subtask/${subtaskId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `title=${encodeURIComponent(title)}&planned_date=${encodeURIComponent(plannedDate)}`
        });
        
        const result = await response.json();
        
        if (result.success) {
            loadSubtasks(currentTaskId); // Перезагружаем список подзадач
        } else {
            alert('Ошибка обновления подзадачи: ' + (result.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Ошибка обновления подзадачи:', error);
        alert('Ошибка обновления подзадачи: ' + error.message);
    }
}

// Функция отмены редактирования подзадачи
function cancelEditSubtask(subtaskId) {
    loadSubtasks(currentTaskId); // Просто перезагружаем список подзадач
}

// Функция удаления подзадачи
async function deleteSubtask(subtaskId) {
    if (!confirm('Вы уверены, что хотите удалить эту подзадачу?')) {
        return;
    }
    
    try {
        const response = await fetch(`/task/${currentTaskId}/subtask/${subtaskId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            loadSubtasks(currentTaskId); // Перезагружаем список подзадач
        } else {
            alert('Ошибка удаления подзадачи: ' + (result.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Ошибка удаления подзадачи:', error);
        alert('Ошибка удаления подзадачи: ' + error.message);
    }
}

// Функция показа модального окна отчета
function showReportModal(subtaskId) {
    // Создаем модальное окно для добавления отчета
    const modalOverlay = document.createElement('div');
    modalOverlay.style.position = 'fixed';
    modalOverlay.style.top = '0';
    modalOverlay.style.left = '0';
    modalOverlay.style.width = '100%';
    modalOverlay.style.height = '100%';
    modalOverlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
    modalOverlay.style.zIndex = '9999';
    modalOverlay.style.display = 'flex';
    modalOverlay.style.justifyContent = 'center';
    modalOverlay.style.alignItems = 'center';

    const modalContent = document.createElement('div');
    modalContent.style.backgroundColor = 'white';
    modalContent.style.padding = '20px';
    modalContent.style.borderRadius = '8px';
    modalContent.style.width = '500px';
    modalContent.style.maxWidth = '90%';
    modalContent.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';

    modalContent.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3>Отчет по подзадаче</h3>
            <button id="close-report-modal" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        <div class="form-group">
            <label for="report-comment">Комментарий:</label>
            <textarea id="report-comment" rows="4" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;" placeholder="Добавьте комментарий к отчету..."></textarea>
        </div>
        <div class="form-group">
            <label for="report-file">Файл (необязательно):</label>
            <input type="file" id="report-file" style="width: 100%;">
        </div>
        <div class="form-actions" style="margin-top: 15px;">
            <button type="button" class="btn btn-success" onclick="submitSubtaskReport('${subtaskId}')">Отправить отчет</button>
            <button type="button" class="btn btn-secondary" onclick="closeReportModal()">Отмена</button>
        </div>
    `;

    modalOverlay.appendChild(modalContent);
    document.body.appendChild(modalOverlay);

    // Обработчик закрытия модального окна
    document.getElementById('close-report-modal').onclick = closeReportModal;
    modalOverlay.onclick = function(event) {
        if (event.target === modalOverlay) {
            closeReportModal();
        }
    };
}

// Функция отправки отчета по подзадаче
async function submitSubtaskReport(subtaskId) {
    const comment = document.getElementById('report-comment').value.trim();
    const fileInput = document.getElementById('report-file');
    const file = fileInput.files[0];
    
    const formData = new FormData();
    formData.append('report', comment);
    
    if (file) {
        formData.append('file', file);
    }

    try {
        const response = await fetch(`/task/${currentTaskId}/subtask/${subtaskId}/upload_file`, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            closeReportModal();
            loadSubtasks(currentTaskId); // Перезагружаем список подзадач
            alert('Отчет успешно отправлен');
        } else {
            alert('Ошибка отправки отчета: ' + (result.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Ошибка отправки отчета:', error);
        alert('Ошибка отправки отчета: ' + error.message);
    }
}

// Функция закрытия модального окна отчета
function closeReportModal() {
    const modalOverlay = document.querySelector('[style*="position: fixed"]');
    if (modalOverlay) {
        modalOverlay.remove();
    }
}

// Функция форматирования размера файла
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}
</script>

{% endblock %}
