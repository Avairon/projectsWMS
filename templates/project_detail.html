{% extends "base.html" %}

{% block content %}
<div class="project-detail">
    <h2>{{ project.name }}</h2>
    
    <div class="project-info">
        <div class="info-grid">
            <div class="info-item">
                <strong>Направление:</strong>
                <p>{{ project.direction }}</p>
            </div>
            <div class="info-item">
                <strong>Статус:</strong>
                <p class="status-badge {% if project.status == 'в работе' %}status-active{% elif project.status == 'завершен' %}status-completed{% else %}status-paused{% endif %}">
                    {{ project.status }}
                </p>
            </div>
            <div class="info-item">
                <strong>Дата старта:</strong>
                <p>{{ project.start_date }}</p>
            </div>
            <div class="info-item">
                <strong>Дата завершения:</strong>
                <p>{{ project.end_date }}</p>
            </div>
            <div class="info-item">
                <strong>Последняя активность:</strong>
                <p>{{ project.last_activity }}</p>
            </div>
            <div class="info-item">
                <strong>Куратор:</strong>
                <p>{{ supervisor.name if supervisor else 'Не назначен' }}</p>
            </div>
            <div class="info-item">
                <strong>Руководитель:</strong>
                <p>{{ manager.name if manager else 'Не назначен' }}</p>
            </div>
        </div>
    </div>
    
    <div class="project-description">
        <h3>Описание проекта</h3>
        <p>{{ project.description or 'Описание отсутствует' }}</p>
    </div>
    
    <div class="project-result">
        <h3>Планируемый результат</h3>
        <p>{{ project.expected_result or 'Результат не определен' }}</p>
    </div>
    
    <div class="project-team">
        <h3>Команда проекта</h3>
        {% if team_members %}
            <ul class="team-list">
                {% for member in team_members %}
                <li>{{ member.name }}</li>
                {% endfor %}
            </ul>
        {% else %}
            <p>Команда не назначена</p>
        {% endif %}
        
        {% if current_user.role == 'admin' or current_user.id == project.manager_id %}
            <div class="actions-bar">
                <a href="{{ url_for('edit_project', project_id=project['id']) }}" class="btn">Редактировать проект</a>
                <a href="{{ url_for('create_task', project_id=project['id']) }}" class="btn">Создать задачу</a>
            </div>
        {% elif current_user.role in ['admin', 'manager'] %}
            <a href="{{ url_for('create_task', project_id=project['id']) }}" class="btn">Создать задачу</a>
        {% endif %}
    </div>
    
    <div class="project-tasks">
    <h3>Задачи проекта</h3>
    {% if tasks %}
        <table class="tasks-table">
            <thead>
                <tr>
                    <th>Задача</th>
                    <th>Исполнитель</th>
                    <th>Дедлайн</th>
                    <th>Статус</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for task in tasks %}
                    {% set assignee = users|selectattr('id', 'equalto', task.assignee_id)|first %}
                    <tr class="{% if task.status == 'активна' %}status-active{% elif task.status == 'завершена' %}status-completed{% else %}status-paused{% endif %}">
                        <td>{{ task.title }}</td>
                        <td>{{ assignee.name if assignee else 'Не назначен' }}</td>
                        <td>{{ task.deadline }}</td>
                        <td>
                            <span class="status-badge {% if task.status == 'активна' %}status-active{% elif task.status == 'завершена' %}status-completed{% else %}status-paused{% endif %}">
                                {{ task.status }}
                            </span>
                        </td>
                        <td>
                            {% if current_user.role in ['admin', 'manager'] or (current_user.id == task.assignee_id if assignee else false) %}
                                <form method="POST" action="{{ url_for('update_task_status', task_id=task['id']) }}" class="status-form">
                                    <select name="status" class="status-select" onchange="this.form.submit()">
                                        <option value="активна" {% if task.status == 'активна' %}selected{% endif %}>Активна</option>
                                        <option value="завершена" {% if task.status == 'завершена' %}selected{% endif %}>Завершена</option>
                                        <option value="отложена" {% if task.status == 'отложена' %}selected{% endif %}>Отложена</option>
                                    </select>
                                </form>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>Задачи для этого проекта еще не созданы</p>
    {% endif %}
    
    <a href="{{ url_for('dashboard') }}" class="btn back-btn">Назад к панели управления</a>
</div>
{% endblock %}