{% extends 'base.html' %}

{% block title %}{{ project.name }} - НХТК{% endblock %}

{% block content %}
<div class="project-detail">
    <div class="actions-bar">
        <a href="{{ url_for('dashboard.dashboard') }}" class="btn back-btn">Назад</a>
        {% if current_user.role in ['admin', 'manager'] %}
        <a href="{{ url_for('projects.edit_project', project_id=project.id) }}" class="btn">Редактировать</a>
        {% endif %}
    </div>

    <h2>{{ project.name }}</h2>

    <div class="project-tabs">
        <button class="tab-btn active" data-tab="info">Информация</button>
        <button class="tab-btn" data-tab="tasks">Задачи</button>
        <button class="tab-btn" data-tab="gantt">Диаграмма Ганта</button>
        <button class="tab-btn" data-tab="team">Команда</button>
    </div>

    <div class="tab-content active" id="info">
        <div class="info-grid">
            <div class="info-item">
                <strong>Направление</strong>
                <p>{{ project.direction }}</p>
            </div>
            <div class="info-item">
                <strong>Статус</strong>
                <p><span class="status-badge {% if project.status == 'в работе' %}status-active{% elif project.status == 'завершен' %}status-completed{% else %}status-paused{% endif %}">{{ project.status }}</span></p>
            </div>
            <div class="info-item">
                <strong>Дата начала</strong>
                <p>{{ project.start_date }}</p>
            </div>
            <div class="info-item">
                <strong>Дата окончания</strong>
                <p>{{ project.end_date }}</p>
            </div>
            <div class="info-item">
                <strong>Куратор</strong>
                <p>{{ supervisor.name if supervisor else 'Не назначен' }}</p>
            </div>
            <div class="info-item">
                <strong>Руководитель</strong>
                <p>{{ manager.name if manager else 'Не назначен' }}</p>
            </div>
        </div>

        <div class="project-description">
            <h3>Описание</h3>
            <p>{{ project.description or 'Нет описания' }}</p>
        </div>

        <div class="project-result">
            <h3>Ожидаемый результат</h3>
            <p>{{ project.expected_result or 'Не указан' }}</p>
        </div>
    </div>

    <div class="tab-content" id="tasks">
        <div class="section-header">
            <h3>Задачи проекта</h3>
            {% if current_user.role in ['admin', 'manager'] %}
            <a href="{{ url_for('tasks.create_task', project_id=project.id) }}" class="btn">Создать задачу</a>
            {% endif %}
        </div>

        {% if tasks %}
        <table class="tasks-table">
            <thead>
                <tr>
                    <th>Название</th>
                    <th>Исполнитель</th>
                    <th>Дедлайн</th>
                    <th>Статус</th>
                </tr>
            </thead>
            <tbody>
                {% for task in tasks %}
                <tr class="task-row" onclick="showTaskModal('{{ task.id }}')">
                    <td>{{ task.title }}</td>
                    <td>
                        {% for user in users if user.id == task.assignee_id %}
                            {{ user.name }}
                        {% else %}
                            Не назначен
                        {% endfor %}
                    </td>
                    <td>{{ task.deadline }}</td>
                    <td>
                        <span class="status-badge {% if task.status == 'активна' %}status-active{% elif task.status == 'завершена' %}status-completed{% else %}status-paused{% endif %}">
                            {{ task.status }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="no-data">Нет задач в проекте</p>
        {% endif %}
    </div>

    <div class="tab-content" id="gantt">
        <div class="gantt-container">
            <div class="gantt-header">
                <h3>Диаграмма Ганта</h3>
                <div class="gantt-controls">
                    <button class="btn small-btn" onclick="zoomGantt('in')">+</button>
                    <button class="btn small-btn" onclick="zoomGantt('out')">-</button>
                </div>
            </div>
            <div class="gantt-chart" id="gantt-chart">
                <div class="gantt-timeline" id="gantt-timeline"></div>
                <div class="gantt-tasks" id="gantt-tasks"></div>
            </div>
            <div class="gantt-legend">
                <div class="legend-item">
                    <div class="legend-color status-active"></div>
                    <span>Активна</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color status-completed"></div>
                    <span>Завершена</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color status-paused"></div>
                    <span>Отложена</span>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-content" id="team">
        <div class="team-section">
            <h3>Команда проекта</h3>
            {% if team_members %}
            <div class="team-grid">
                {% for member in team_members %}
                <div class="team-member-card">
                    <div class="member-avatar">{{ member.name[0] }}</div>
                    <div class="member-info">
                        <h4>{{ member.name }}</h4>
                        <span class="role-badge role-{{ member.role }}">
                            {% if member.role == 'admin' %}Администратор
                            {% elif member.role == 'manager' %}Руководитель
                            {% elif member.role == 'supervisor' %}Куратор
                            {% else %}Исполнитель
                            {% endif %}
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="no-data">Команда не сформирована</p>
            {% endif %}
        </div>
    </div>
</div>

<div class="modal" id="task-modal">
    <div class="modal-overlay" onclick="closeTaskModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-task-title">Задача</h3>
            <button class="modal-close" onclick="closeTaskModal()">&times;</button>
        </div>
        <div class="modal-body" id="modal-task-body">
        </div>
        <div class="modal-footer">
            <button class="btn cancel-btn" onclick="closeTaskModal()">Закрыть</button>
        </div>
    </div>
</div>

<div class="tooltip" id="gantt-tooltip"></div>

<script>
    const projectId = '{{ project.id }}';
    const tasks = {{ tasks | tojson | safe }};
    const projectStartDate = '{{ project.start_date }}';
    const projectEndDate = '{{ project.end_date }}';
</script>
{% endblock %}
