{% extends "base.html" %}

{% block content %}
<div class="project-detail">
    <h2>{{ project.name }}</h2>
    
    <div class="project-tabs">
        <button class="tab-btn active" data-tab="info">Информация</button>
        <button class="tab-btn" data-tab="gantt">График Ганта</button>
        <button class="tab-btn" data-tab="team">Команда</button>
    </div>
    
    <div class="tab-content active" id="tab-info">
        <div class="project-info">
            <div class="info-grid">
                <div class="info-item">
                    <strong>Направление:</strong>
                    <p>{{ project.direction }}</p>
                </div>
                <div class="info-item">
                    <strong>Статус:</strong>
                    <p class="status-badge {% if project.status == 'в работе' %}status-active{% elif project.status == 'завершен' %}status-completed{% else %}status-paused{% endif %}">
                        {{ project.status }}
                    </p>
                </div>
                <div class="info-item">
                    <strong>Дата старта:</strong>
                    <p>{{ project.start_date }}</p>
                </div>
                <div class="info-item">
                    <strong>Дата завершения:</strong>
                    <p>{{ project.end_date }}</p>
                </div>
                <div class="info-item">
                    <strong>Последняя активность:</strong>
                    <p>{{ project.last_activity }}</p>
                </div>
                <div class="info-item">
                    <strong>Куратор:</strong>
                    <div class="info-with-button">
                        <p>{{ supervisor.name if supervisor else 'Не назначен' }}</p>
                        {% if current_user.role == 'admin' or current_user.id == project.manager_id %}
                        <button class="btn small-btn" onclick="openChangeCuratorModal()">Изменить</button>
                        {% endif %}
                    </div>
                </div>
                <div class="info-item">
                    <strong>Руководитель:</strong>
                    <div class="info-with-button">
                        <p>{{ manager.name if manager else 'Не назначен' }}</p>
                        {% if current_user.role == 'admin' %}
                        <button class="btn small-btn" onclick="openChangeManagerModal()">Изменить</button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="project-description">
            <h3>Описание проекта</h3>
            <p>{{ project.description or 'Описание отсутствует' }}</p>
        </div>
        
        <div class="project-result">
            <h3>Планируемый результат</h3>
            <p>{{ project.expected_result or 'Результат не определен' }}</p>
        </div>
        
        <div class="project-tasks">
            <div class="section-header">
                <h3>Задачи проекта</h3>
                {% if current_user.role in ['admin', 'manager', 'supervisor'] or current_user.id == project.manager_id %}
                    <a href="{{ url_for('create_task', project_id=project['id']) }}" class="btn">+ Создать задачу</a>
                {% endif %}
            </div>
            
            {% if tasks %}
                <table class="tasks-table">
                    <thead>
                        <tr>
                            <th>Задача</th>
                            <th>Исполнитель</th>
                            <th>Дедлайн</th>
                            <th>Статус</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in tasks %}
                            {% set assignee = users|selectattr('id', 'equalto', task.assignee_id)|first %}
                            <tr class="task-row {% if task.status == 'активна' %}status-active{% elif task.status == 'завершена' %}status-completed{% else %}status-paused{% endif %}" 
                                data-task-id="{{ task.id }}"
                                onclick="openTaskModal('{{ task.id }}')">
                                <td>{{ task.title }}</td>
                                <td>{{ assignee.name if assignee else 'Не назначен' }}</td>
                                <td>{{ task.deadline }}</td>
                                <td>
                                    <span class="status-badge {% if task.status == 'активна' %}status-active{% elif task.status == 'завершена' %}status-completed{% else %}status-paused{% endif %}">
                                        {{ task.status }}
                                    </span>
                                </td>
                                <td onclick="event.stopPropagation()">
                                    {% if current_user.role in ['admin', 'manager', 'supervisor'] or (current_user.id == task.assignee_id if assignee else false) %}
                                        <form method="POST" action="{{ url_for('update_task_status', task_id=task['id']) }}" class="status-form">
                                            <select name="status" class="status-select" onchange="this.form.submit()">
                                                <option value="активна" {% if task.status == 'активна' %}selected{% endif %}>Активна</option>
                                                <option value="завершена" {% if task.status == 'завершена' %}selected{% endif %}>Завершена</option>
                                                <option value="отложена" {% if task.status == 'отложена' %}selected{% endif %}>Отложена</option>
                                            </select>
                                        </form>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p class="no-data">Задачи для этого проекта еще не созданы</p>
            {% endif %}
        </div>
        
        {% if current_user.role == 'admin' or current_user.id == project.manager_id %}
            <div class="actions-bar">
                <a href="{{ url_for('edit_project', project_id=project['id']) }}" class="btn">Редактировать проект</a>
            </div>
        {% endif %}
    </div>
    
    <div class="tab-content" id="tab-gantt">
        <div class="gantt-container">
            <div class="gantt-header">
                <h3>График выполнения задач</h3>
                <div class="gantt-controls">
                    <button class="btn small-btn" onclick="ganttZoom('in')">+</button>
                    <button class="btn small-btn" onclick="ganttZoom('out')">-</button>
                    <button class="btn small-btn" onclick="ganttToday()">Сегодня</button>
                </div>
            </div>
            <div class="gantt-chart" id="gantt-chart">
                <div class="gantt-timeline" id="gantt-timeline"></div>
                <div class="gantt-tasks" id="gantt-tasks"></div>
            </div>
            <div class="gantt-legend">
                <div class="legend-item"><span class="legend-color status-active"></span> Активна</div>
                <div class="legend-item"><span class="legend-color status-completed"></span> Завершена</div>
                <div class="legend-item"><span class="legend-color status-paused"></span> Отложена</div>
            </div>
        </div>
    </div>
    
    <div class="tab-content" id="tab-team">
        <div class="team-section">
            <div class="section-header">
                <h3>Команда проекта</h3>
                {% if current_user.role in ['admin', 'manager', 'supervisor'] or current_user.id == project.supervisor_id %}
                    <button class="btn" onclick="openAddMemberModal()">+ Добавить участника</button>
                {% endif %}
            </div>
            
            {% if team_members %}
                <div class="team-grid">
                    {% for member in team_members %}
                    <div class="team-member-card">
                        <div class="member-avatar">{{ member.name[:1] }}</div>
                        <div class="member-info">
                            <h4>{{ member.token if member.token else member.name }}</h4>
                            <span class="role-badge role-{{ member.role }}">
                                {% if member.role == 'admin' %}Администратор
                                {% elif member.role == 'manager' %}Руководитель
                                {% elif member.role == 'supervisor' %}Куратор
                                {% elif member.role == 'worker' %}Исполнитель
                                {% else %}{{ member.role }}
                                {% endif %}
                            </span>
                        </div>
                        {% if current_user.role in ['admin', 'manager', 'supervisor'] and member.id != current_user.id %}
                        <button class="btn small-btn delete-btn" onclick="removeMember('{{ member.id }}')">Удалить</button>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="no-data">Команда не назначена</p>
            {% endif %}
        </div>
    </div>
    
    <a href="{{ url_for('dashboard') }}" class="btn back-btn">Назад к панели управления</a>
</div>

<div class="modal" id="task-modal">
    <div class="modal-overlay" onclick="closeTaskModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-task-title">Детали задачи</h3>
            <button class="modal-close" onclick="closeTaskModal()">&times;</button>
        </div>
        <div class="modal-body" id="modal-task-body">
            <div class="task-detail-grid">
                <div class="task-detail-item">
                    <strong>Описание:</strong>
                    <p id="modal-task-description"></p>
                </div>
                <div class="task-detail-item">
                    <strong>Статус:</strong>
                    <span id="modal-task-status" class="status-badge"></span>
                </div>
                <div class="task-detail-item">
                    <strong>Исполнитель:</strong>
                    <p id="modal-task-assignee"></p>
                    {% if current_user.role in ['admin', 'manager', 'supervisor'] %}
                    <button class="btn small-btn" onclick="openChangeAssigneeModal()">Изменить</button>
                    {% endif %}
                </div>
                <div class="task-detail-item">
                    <strong>Дата начала:</strong>
                    <p id="modal-task-start"></p>
                </div>
                <div class="task-detail-item">
                    <strong>Дедлайн:</strong>
                    <p id="modal-task-deadline"></p>
                </div>
            </div>
            
            <div class="task-files-section">
                <h4>Прикрепленные файлы</h4>
                <div id="modal-task-files" class="files-list"></div>
                <div id="file-upload-section" class="file-upload" style="display: none;">
                    <input type="file" id="task-file-input" multiple>
                    <button class="btn small-btn" onclick="uploadTaskFile()">Загрузить файл</button>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn cancel-btn" onclick="closeTaskModal()">Закрыть</button>
        </div>
    </div>
</div>

<div class="modal" id="add-member-modal">
    <div class="modal-overlay" onclick="closeAddMemberModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Добавить участника</h3>
            <button class="modal-close" onclick="closeAddMemberModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="member-token">Токен участника:</label>
                <input type="text" id="member-token" placeholder="Введите токен пользователя">
                <small>Введите токен пользователя для добавления в команду проекта</small>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="addMemberByToken()">Добавить</button>
            <button class="btn cancel-btn" onclick="closeAddMemberModal()">Отмена</button>
        </div>
    </div>
</div>

<div class="modal" id="change-assignee-modal">
    <div class="modal-overlay" onclick="closeChangeAssigneeModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Изменить ответственного</h3>
            <button class="modal-close" onclick="closeChangeAssigneeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="new-assignee">Выберите нового исполнителя:</label>
                <select id="new-assignee">
                    {% for user in users %}
                    <option value="{{ user.id }}">{{ user.name }} ({{ user.role }})</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="changeAssignee()">Сохранить</button>
            <button class="btn cancel-btn" onclick="closeChangeAssigneeModal()">Отмена</button>
        </div>
    </div>
</div>

{% if current_user.role == 'admin' or current_user.id == project.manager_id %}
<div class="modal" id="change-curator-modal">
    <div class="modal-overlay" onclick="closeChangeCuratorModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Изменить куратора проекта</h3>
            <button class="modal-close" onclick="closeChangeCuratorModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="new-curator">Выберите нового куратора:</label>
                <select id="new-curator">
                    {% for user in users %}
                        {% if user.role == 'supervisor' %}
                        <option value="{{ user.id }}" {% if user.id == project.supervisor_id %}selected{% endif %}>{{ user.name }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="changeCurator()">Сохранить</button>
            <button class="btn cancel-btn" onclick="closeChangeCuratorModal()">Отмена</button>
        </div>
    </div>
</div>
{% endif %}

{% if current_user.role == 'admin' %}
<div class="modal" id="change-manager-modal">
    <div class="modal-overlay" onclick="closeChangeManagerModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Изменить менеджера проекта</h3>
            <button class="modal-close" onclick="closeChangeManagerModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="new-manager">Выберите нового менеджера:</label>
                <select id="new-manager">
                    {% for user in users %}
                        {% if user.role == 'manager' %}
                        <option value="{{ user.id }}" {% if user.id == project.manager_id %}selected{% endif %}>{{ user.name }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="changeManager()">Сохранить</button>
            <button class="btn cancel-btn" onclick="closeChangeManagerModal()">Отмена</button>
        </div>
    </div>
</div>
{% endif %}

<div class="tooltip" id="gantt-tooltip"></div>

<script>
const projectId = '{{ project.id }}';
const projectStartDate = '{{ project.start_date }}';
const projectEndDate = '{{ project.end_date }}';
const tasksData = {{ tasks | tojson | safe }};
const usersData = {{ users | tojson | safe }};
const currentUserRole = '{{ current_user.role }}';
</script>
{% endblock %}
